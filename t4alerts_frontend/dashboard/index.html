<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T4 Alerts - Error Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <!-- Load Core Modules -->
    <script src="../static/js/core/Logger.js"></script>
    <script src="../static/js/core/Config.js"></script>
    <script src="../static/js/core/ViewFactory.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <h2>T4<span class="neon-blue">Alerts</span></h2>
            </div>

            <nav class="nav-menu">
                <!-- Accordion: Statistics -->
                <div class="accordion-header" id="accordion-stats" onclick="toggleAccordion('stats-content')">
                    <span class="icon">üìä</span> Statistics
                    <span style="margin-left: auto; font-size: 0.8em;">‚ñº</span>
                </div>
                <div id="stats-content" class="accordion-content">
                    <div id="apps-list-container">
                        <!-- Apps injected here dynamically -->
                        <div class="sub-nav-item">Loading apps...</div>
                    </div>
                </div>

                <div class="nav-item" onclick="ViewFactory.navigateTo('certificates')">
                    <span class="icon">üîí</span> SSL Monitor
                </div>
                <div class="nav-item" onclick="ViewFactory.navigateTo('error-history')">
                    <span class="icon">üïí</span> Error History
                </div>
                <div class="nav-item" onclick="ViewFactory.navigateTo('custom-scan')">
                    <span class="icon">‚ö°</span> Custom Scan
                </div>
                <div class="nav-item" onclick="ViewFactory.navigateTo('menu')">
                    <span class="icon">üè†</span> Main Menu
                </div>
            </nav>

            <div class="user-profile">
                <div class="avatar">Admin</div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="top-bar">
                <h1 id="page-title">Dashboard Overview</h1>
                <div class="date-display" id="current-date">Loading date...</div>
            </header>

            <div id="loading" class="loading" style="display: none;">Fetching data...</div>

            <!-- VIEW: Error History -->
            <div id="view-error-history" style="display: none;">

                <div class="date-selector" style="justify-content: space-between; margin-bottom: 20px;">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <label>Scan Date:</label>
                        <input type="date" id="history-scan-date" value="">
                        <button class="tab-btn active" style="border: 1px solid var(--neon-blue); border-radius: 4px;"
                            onclick="scanAllApps()">
                            ‚ö° SCAN ALL APPS
                        </button>
                    </div>
                    <div id="scan-status" style="color: var(--neon-blue); font-size: 0.9em; display: none;">
                        Scanning... please wait...
                    </div>
                </div>

                <div class="history-container">
                    <div class="history-header">
                        <div onclick="sortHistory('app_name')" style="cursor: pointer; user-select: none;">
                            APP <span id="sort-app_name"></span>
                        </div>
                        <div onclick="sortHistory('first_seen')" style="cursor: pointer; user-select: none;">
                            DATE <span id="sort-first_seen"></span>
                        </div>
                        <div>ERROR PREVIEW</div>
                    </div>
                    <div id="history-list" class="history-list">
                        <!-- Injected via script.js -->
                    </div>
                    <div id="history-loading" style="text-align: center; padding: 20px; display: none; color: #888;">
                        Loading history...
                    </div>
                </div>
            </div>

            <!-- Stats/Logs View Container -->
            <div id="app-view-container" style="display: none;">

                <div class="date-selector">
                    <label>Select Date:</label>
                    <input type="date" id="stats-date-picker">
                </div>

                <div class="tabs-container">
                    <button class="tab-btn active" onclick="switchTab('logs')">LOGS</button>
                    <button class="tab-btn" onclick="switchTab('stats')">STATS</button>
                </div>

                <!-- View: LOGS -->
                <div id="view-logs" class="logs-section">
                    <div class="log-group">
                        <h3>Errors</h3>
                        <div id="logs-uncontrolled" class="log-list">
                            <!-- Injected -->
                        </div>
                    </div>
                    <div class="log-group controlled">
                        <h3>Errors (controlled)</h3>
                        <div id="logs-controlled" class="log-list">
                            <!-- Injected -->
                        </div>
                    </div>
                </div>

                <div id="view-stats" class="stats-view" style="display: none;">
                    <div class="chart-card large">
                        <div class="canvas-container" id="chart-container">
                            <canvas id="sqlChart"></canvas>
                        </div>
                    </div>
                    <!-- Placeholder for other stats or maybe re-use donut -->
                </div>
            </div>

            <!-- Placeholder for initial Dashboard Overview (if we want to keep it) -->
            <div id="dashboard-overview" class="charts-grid" style="display: none;">
                <!-- Bar Chart: Errors per App -->
                <div class="chart-card large">
                    <h3>Uncontrolled Errors per App</h3>
                    <div class="canvas-container">
                        <canvas id="barChart"></canvas>
                    </div>
                </div>

                <!-- Donut Chart: Error Types -->
                <div class="chart-card small">
                    <h3>Error Distribution</h3>
                    <div class="canvas-container">
                        <canvas id="donutChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Custom Scan Form -->
            <div id="custom-scan-view" style="display: none;">
                <h2>‚ö° Custom App Scan</h2>
                <p class="subtitle">Scan any application on-demand without configuration</p>

                <form id="custom-scan-form" class="custom-scan-form">
                    <!-- Template Loader -->
                    <div class="form-row"
                        style="margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 20px;">
                        <div class="form-group">
                            <label for="scan-template">üìÇ Load from existing app (Optional)</label>
                            <select id="scan-template" class="dark-input">
                                <option value="">-- Select an app to autofill --</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="scan-base-url">Base URL *</label>
                            <input type="url" id="scan-base-url" placeholder="https://example.com" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="scan-app-name">App Name (for saving later)</label>
                            <input type="text" id="scan-app-name" placeholder="My New App">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="scan-login-path">Login Path</label>
                            <input type="text" id="scan-login-path" value="/login" placeholder="/login">
                        </div>
                        <div class="form-group">
                            <label for="scan-logs-path">Logs Path</label>
                            <input type="text" id="scan-logs-path" value="/logs" placeholder="/logs">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="scan-username">Username *</label>
                            <input type="text" id="scan-username" placeholder="Login username" required>
                        </div>
                        <div class="form-group">
                            <label for="scan-password">Password *</label>
                            <input type="password" id="scan-password" placeholder="Login password" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="scan-date">Scan Date</label>
                            <input type="date" id="scan-date">
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn-primary" id="btn-start-scan">
                            üöÄ Start Scan
                        </button>
                    </div>
                </form>

                <!-- Results Container -->
                <div id="custom-scan-results" style="display: none; margin-top: 30px;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3>Scan Results</h3>
                        <button id="btn-save-app" class="btn-success"
                            style="display: none; background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">
                            üíæ Save & Add to Menu
                        </button>
                    </div>
                    <!-- Content will be injected into a new div -->
                    <div id="scan-results-content"></div>
                </div>
            </div>

            <!-- Notifications Feed (Keep on Overview) -->
            <div class="notifications-section" id="feed-container" style="display: none;">
                <h3>Recent Alerts Feed</h3>
                <div class="feed-header">
                    <span>App</span>
                    <span>Signature</span>
                    <span>Last Seen</span>
                    <span>Recurrence</span>
                </div>
                <div id="feed-list" class="feed-list">
                </div>
            </div>
        </main>
    </div>

    <!-- Session Expired Modal -->
    <div id="session-expired-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <div class="modal-header" style="justify-content: center;">
                <h3>‚ö†Ô∏è Session Expired</h3>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <p>Your session has expired due to inactivity.</p>
                <p>Please log in again to continue.</p>
            </div>
            <div class="modal-footer" style="justify-content: center;">
                <button class="btn-primary" onclick="redirectToLogin()">OK, Log In</button>
            </div>
        </div>
    </div>

    <!-- Email Modal -->
    <div id="email-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2 id="email-modal-title">üì® Send Manual Email</h2>

            <div class="input-group">
                <label for="email-to">Recipients (comma separated):</label>
                <input type="text" id="email-to" placeholder="user@example.com, admin@example.com" class="dark-input">
            </div>

            <div class="input-group">
                <label for="email-subject">Subject:</label>
                <input type="text" id="email-subject" class="dark-input">
            </div>

            <div class="input-group">
                <label for="email-body">Message:</label>
                <textarea id="email-body" rows="10" class="dark-input code-font"></textarea>
            </div>

            <div class="modal-actions">
                <button onclick="closeEmailModal()" class="btn-cancel">Cancel</button>
                <button onclick="submitErrorEmail()" class="btn-send" id="btn-submit-email">Send Email</button>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
</body>

</html>