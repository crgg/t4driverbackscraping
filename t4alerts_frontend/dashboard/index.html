<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T4 Alerts - Error Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <!-- Load Core Modules -->
    <script src="../static/js/core/Logger.js"></script>
    <script src="../static/js/core/Config.js"></script>
    <script src="../shared/PermissionManager.js"></script>
    <script src="../static/js/core/ViewFactory.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header"
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                <div class="logo" style="margin-bottom: 0; padding-bottom: 0; border-bottom: none;">
                    <h2 style="margin: 0; font-size: 1.5rem;">T4<span class="neon-blue">Alerts</span></h2>
                </div>
                <button id="sidebar-toggle" onclick="toggleSidebar()"
                    style="background: transparent; border: none; color: var(--neon-blue); font-size: 1.2rem; cursor: pointer; padding: 5px;">
                    &#9664; <!-- Left arrow -->
                </button>
            </div>

            <nav class="nav-menu">
                <!-- Accordion: Statistics -->
                <div class="accordion-header" id="accordion-stats" onclick="toggleAccordion('stats-content')">
                    <span class="icon">üìä</span> Logs / Stats
                    <span id="stats-accordion-arrow" style="margin-left: auto; font-size: 0.8em;">‚ñº</span>
                </div>
                <div id="stats-content" class="accordion-content">
                    <div id="apps-list-container">
                        <!-- Apps injected here dynamically -->
                        <div class="sub-nav-item">Loading apps...</div>
                    </div>
                </div>


                <div class="nav-item" onclick="ViewFactory.navigateTo('error-history')">
                    <span class="icon">üïí</span> Error History
                </div>

                <div class="nav-item" onclick="ViewFactory.navigateTo('custom-scan')">
                    <span class="icon">‚ö°</span> Custom Scan
                </div>
                <div class="nav-item" onclick="ViewFactory.navigateTo('menu')">
                    <span class="icon">üè†</span> Main Menu
                </div>
            </nav>

            <div class="user-profile">
                <div class="avatar" id="user-role-display">Admin</div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="top-bar">
                <h1 id="page-title">Dashboard Overview</h1>
                <div style="display: flex; align-items: center; gap: 20px;">
                    <div class="date-display" id="current-date">Loading date...</div>
                    <button onclick="logout()" class="logout-btn-header">Logout</button>
                </div>
            </header>

            <div id="loading" class="loading" style="display: none;">Fetching data...</div>

            <!-- VIEW: Error History -->
            <div id="view-error-history" style="display: none;">


                <div class="date-selector"
                    style="justify-content: space-between; margin-bottom: 20px; align-items: flex-end;">
                    <div
                        style="padding: 12px 20px; background: rgba(0, 243, 255, 0.1); border-left: 3px solid var(--neon-blue); border-radius: 4px; color: #ccc; font-size: 0.9em; max-width: 60%;">
                        üí° <strong>Tip:</strong> El historial se actualiza autom√°ticamente cada vez que haces scraping
                        desde <strong>Custom Scan</strong> o desde <strong>Logs/Stats</strong> de cada aplicaci√≥n.
                    </div>

                    <!-- Search Bar -->
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        <input type="text" id="history-search" placeholder="üîç Search by app name..."
                            onkeyup="filterHistory()"
                            style="padding: 10px 15px; width: 250px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: #fff; outline: none;">
                    </div>
                </div>


                <div class="history-container">
                    <div class="history-header">
                        <div onclick="sortHistory('app_name')" style="cursor: pointer; user-select: none;">
                            APP <span id="sort-app_name"></span>
                        </div>
                        <div onclick="sortHistory('first_seen')" style="cursor: pointer; user-select: none;">
                            DATE <span id="sort-first_seen"></span>
                        </div>
                        <div>ERROR PREVIEW</div>
                    </div>
                    <div id="history-list" class="history-list">
                        <!-- Injected via script.js -->
                    </div>

                    <!-- Pagination Controls -->
                    <div id="history-pagination"
                        style="display: none; justify-content: center; align-items: center; gap: 20px; padding: 20px; margin-top: 10px; border-top: 1px solid rgba(255,255,255,0.05);">
                        <button onclick="changeHistoryPage(-1)" class="tab-btn" style="padding: 5px 15px;">&lt;
                            Previous</button>
                        <span id="history-page-info" style="color: #aaa; font-size: 0.9em;">Page 1</span>
                        <button onclick="changeHistoryPage(1)" class="tab-btn" style="padding: 5px 15px;">Next
                            &gt;</button>
                    </div>

                    <div id="history-loading" style="text-align: center; padding: 20px; display: none; color: #888;">
                        Loading history...
                    </div>
                </div>
            </div>

            <!-- Stats/Logs View Container -->
            <div id="app-view-container" style="display: none;">

                <div class="date-selector">
                    <label>Select Date:</label>
                    <input type="date" id="stats-date-picker">
                </div>

                <!-- Search Bar -->
                <div style="display: flex; justify-content: flex-end; margin-bottom: 15px; gap: 10px;">
                    <button onclick="openManualNoticeModal()" class="tab-btn"
                        style="border: 1px solid var(--neon-blue); color: var(--neon-blue);">
                        üîî Manual Notice
                    </button>
                    <input type="text" id="app-search-input" placeholder="üîç Search errors (SQL, type, message...)"
                        onkeyup="filterAppErrors()"
                        style="padding: 10px 15px; width: 350px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: #fff; outline: none;">
                </div>

                <div class="tabs-container">
                    <button class="tab-btn active" onclick="switchTab('logs')">LOGS</button>
                    <button class="tab-btn" onclick="switchTab('stats')">STATS</button>
                </div>

                <!-- View: LOGS -->
                <div id="view-logs" class="logs-section">
                    <div class="log-group">
                        <h3>Errors</h3>
                        <div id="logs-uncontrolled" class="log-list">
                            <!-- Injected -->
                        </div>
                    </div>
                    <div class="log-group controlled">
                        <h3>Errors (controlled)</h3>
                        <div id="logs-controlled" class="log-list">
                            <!-- Injected -->
                        </div>
                    </div>
                </div>

                <div id="view-stats" class="stats-view" style="display: none;">
                    <div class="chart-card large">
                        <div class="canvas-container" id="chart-container">
                            <canvas id="sqlChart"></canvas>
                        </div>
                    </div>
                    <!-- Placeholder for other stats or maybe re-use donut -->
                </div>
            </div>

            <!-- Placeholder for initial Dashboard Overview (if we want to keep it) -->
            <div id="dashboard-overview" class="charts-grid" style="display: none;">
                <!-- Bar Chart: Errors per App -->
                <div class="chart-card large">
                    <h3>Uncontrolled Errors per App</h3>
                    <div class="canvas-container">
                        <canvas id="barChart"></canvas>
                    </div>
                </div>

                <!-- Donut Chart: Error Types -->
                <div class="chart-card small">
                    <h3>Error Distribution</h3>
                    <div class="canvas-container">
                        <canvas id="donutChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Custom Scan Results View -->
            <div id="custom-scan-view" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <div>
                        <h2>‚ö° Custom App Scan</h2>
                        <p class="subtitle">Results for your on-demand scan</p>
                    </div>
                    <button onclick="openCustomScanModal()" class="tab-btn active"
                        style="border: 2px solid var(--neon-blue); border-radius: 8px; font-weight: bold;">
                        + NEW SCAN
                    </button>
                </div>

                <!-- Results Container -->
                <div id="custom-scan-results"
                    style="display: none; background: var(--card-bg); border-radius: 12px; padding: 25px; border: 1px solid rgba(255,255,255,0.05);">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px;">
                        <h3 id="scan-results-title">Scan Results</h3>
                        <button id="btn-save-app" class="btn-modal-save" style="display: none;">
                            üíæ Save & Add to Menu
                        </button>
                    </div>
                    <div id="scan-results-content"></div>
                </div>

                <!-- Empty state if no scan yet -->
                <div id="custom-scan-empty" style="text-align: center; padding: 100px 20px; color: #888;">
                    <div style="font-size: 3rem; margin-bottom: 20px; opacity: 0.3;">üöÄ</div>
                    <h3>Ready to scan?</h3>
                    <p>Start a new scan to see logs and statistics for any application.</p>
                    <button onclick="openCustomScanModal()" class="btn-modal-save"
                        style="margin-top: 20px; width: auto; padding-left: 30px; padding-right: 30px;">
                        Start Here
                    </button>
                </div>
            </div>

            <!-- Notices View (COMMENTED OUT) -->
            <!-- 
            <div id="view-notices" style="display: none;">
                <div class="charts-grid">
                    <div class="chart-card large">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <div>
                                <h3>Scheduled Dynamic Scans</h3>
                                <p style="color: #888;">Manage notifications and schedules for your dynamic apps.</p>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="date" id="notices-date-picker" class="dark-input" style="padding: 8px;">
                                <button onclick="sendSelectedNotices()" class="btn-primary"
                                    style="padding: 8px 15px; background: rgba(255, 191, 0, 0.2); color: #ffbf00; border: 1px solid #ffbf00;">
                                    üîî Trigger Notices
                                </button>
                            </div>
                        </div>
                        <div id="notices-list-container">Loading...</div>
                    </div>
                </div>
            </div>
            -->

            <!-- Notifications Feed (Keep on Overview) -->
            <div class="notifications-section" id="feed-container" style="display: none;">
                <h3>Recent Alerts Feed</h3>
                <div class="feed-header">
                    <span>App</span>
                    <span>Signature</span>
                    <span>Last Seen</span>
                    <span>Recurrence</span>
                </div>
                <div id="feed-list" class="feed-list">
                </div>
            </div>
        </main>
    </div>

    <!-- Session Expired Modal -->
    <div id="session-expired-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <div class="modal-header" style="justify-content: center;">
                <h3>‚ö†Ô∏è Session Expired</h3>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <p>Your session has expired due to inactivity.</p>
                <p>Please log in again to continue.</p>
            </div>
            <div class="modal-footer" style="justify-content: center;">
                <button class="btn-primary" onclick="redirectToLogin()">OK, Log In</button>
            </div>
        </div>
    </div>

    <!-- Email Modal -->
    <div id="email-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2 id="email-modal-title">üì® Send Manual Email</h2>

            <div class="input-group">
                <label for="email-to">Recipients (comma separated):</label>
                <input type="text" id="email-to" placeholder="user@example.com, admin@example.com" class="dark-input">
            </div>

            <div class="input-group" style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                <input type="checkbox" id="email-use-template" checked onchange="toggleEmailBody(this.checked)">
                <label for="email-use-template" style="margin-bottom: 0;">Use Standard Report Template</label>
            </div>

            <div class="input-group">
                <label for="email-subject">Subject:</label>
                <input type="text" id="email-subject" class="dark-input">
            </div>

            <div class="input-group">
                <label for="email-body">Message:</label>
                <textarea id="email-body" rows="10" class="dark-input code-font"></textarea>
            </div>

            <div class="modal-actions">
                <button onclick="closeEmailModal()" class="btn-cancel">Cancel</button>
                <button onclick="submitErrorEmail()" class="btn-send" id="btn-submit-email">Send Email</button>
            </div>
        </div>
    </div>

    <!-- Custom Scan Modal (PRD DESIGN) -->
    <div id="custom-scan-modal" class="custom-modal-container" style="display: none;">
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h2>Add Application</h2>
                <button class="close-modal" onclick="closeCustomScanModal()">&times;</button>
            </div>

            <form id="custom-modal-form" class="custom-modal-form">
                <!-- App Key (Hidden from UI, auto-generated) -->
                <div class="custom-form-group" style="display: none;">
                    <label for="m-scan-app-key">App Key *</label>
                    <input type="text" id="m-scan-app-key" class="custom-modal-input" placeholder="p.ej. my_app_key"
                        required>
                </div>

                <!-- App Name -->
                <div class="custom-form-group">
                    <label for="m-scan-app-name">App Name *</label>
                    <input type="text" id="m-scan-app-name" class="custom-modal-input"
                        placeholder="p.ej. My New Application" required>
                </div>

                <!-- Base URL -->
                <div class="custom-form-group">
                    <label for="m-scan-base-url">Base URL *</label>
                    <input type="url" id="m-scan-base-url" class="custom-modal-input" placeholder="https://example.com"
                        required>
                </div>

                <!-- Login & Logs Path Row -->
                <div class="custom-form-row">
                    <div class="custom-form-group">
                        <label for="m-scan-login-path">Login Path</label>
                        <input type="text" id="m-scan-login-path" class="custom-modal-input" value="/login">
                    </div>
                    <div class="custom-form-group">
                        <label for="m-scan-logs-path">Logs Path</label>
                        <input type="text" id="m-scan-logs-path" class="custom-modal-input" value="/logs">
                    </div>
                </div>

                <!-- Username & Password Row -->
                <div class="custom-form-row">
                    <div class="custom-form-group">
                        <label for="m-scan-username">Username *</label>
                        <input type="text" id="m-scan-username" class="custom-modal-input" placeholder="Username"
                            required>
                    </div>
                    <div class="custom-form-group">
                        <label for="m-scan-password">Password *</label>
                        <input type="password" id="m-scan-password" class="custom-modal-input" placeholder="Password"
                            required minlength="4">
                    </div>
                </div>

                <!-- Checkbox (Hidden from UI, active by default) -->
                <div class="custom-checkbox-container" id="m-active-container" style="display: none;">
                    <input type="checkbox" id="m-scan-active" checked>
                    <span>Active (monitor this app)</span>
                </div>

                <!-- Scan Date (Extra, useful for the flow) -->
                <div class="custom-form-group"
                    style="margin-top: 10px; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 15px;">
                    <label for="m-scan-date">Initial Scan Date (Optional)</label>
                    <input type="date" id="m-scan-date" class="custom-modal-input">
                </div>

                <div class="custom-modal-footer">
                    <button type="button" class="btn-modal-cancel" onclick="closeCustomScanModal()">Cancel</button>
                    <button type="submit" class="btn-modal-save" id="btn-modal-start">üöÄ Start Scan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Notices Settings Modal (COMMENTED OUT) -->
    <!--
    <div id="notices-settings-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2>üîî Notification Settings</h2>
            <p id="ns-app-name" style="color: var(--neon-blue); margin-bottom: 15px;"></p>
            <input type="hidden" id="ns-app-key">

            <div class="input-group">
                <label>Recipients (Email addresses, comma separated)</label>
                <input type="text" id="ns-recipients" class="dark-input"
                    placeholder="user@example.com, admin@example.com">
                <small style="color: #666;">Future: SMS numbers support coming soon</small>
            </div>

            <div class="input-group" style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
                <input type="checkbox" id="ns-schedule" style="width: auto;">
                <label for="ns-schedule" style="margin-bottom: 0;">Enable Scheduled Scans (Every 24h)</label>
            </div>

            <div class="modal-actions">
                <button onclick="document.getElementById('notices-settings-modal').style.display='none'"
                    class="btn-cancel">Cancel</button>
                <button onclick="saveNoticesSettings()" class="btn-send">üíæ Save Settings</button>
            </div>
        </div>
    </div>
    -->

    <script src="script.js"></script>
</body>

</html>